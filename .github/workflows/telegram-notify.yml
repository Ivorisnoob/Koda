name: Telegram Notifications

on:
  pull_request:
    types: [opened, closed, reopened]
  issues:
    types: [opened, closed, reopened]
  issue_comment:
    types: [created]
  watch:
    types: [started]  # Stars
  fork:
  release:
    types: [published]

env:
  TELEGRAM_CHAT_ID: "@ivorisnoob_projects"

jobs:

  # Pull Request Opened
  notify-pr-opened:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Send PR Opened Notification
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${{ env.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=<b>Koda</b> | Pull Request

          New PR opened!

          Title: <b>${{ github.event.pull_request.title }}</b>
          Author: <b>${{ github.event.pull_request.user.login }}</b>

          <a href='${{ github.event.pull_request.html_url }}'>View PR</a>"

  # Pull Request Merged
  notify-pr-merged:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Send PR Merged Notification
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${{ env.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=<b>Koda</b> | Merged!

          PR successfully merged!

          Title: <b>${{ github.event.pull_request.title }}</b>
          Merged by: <b>${{ github.event.sender.login }}</b>

          <a href='${{ github.event.pull_request.html_url }}'>View Details</a>"

  # Issue Opened
  notify-issue-opened:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Send Issue Opened Notification
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${{ env.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=<b>Koda</b> | New Issue

          Issue reported!

          Title: <b>${{ github.event.issue.title }}</b>
          Reported by: <b>${{ github.event.issue.user.login }}</b>

          <a href='${{ github.event.issue.html_url }}'>View Issue</a>"

  # Issue Closed
  notify-issue-closed:
    if: github.event_name == 'issues' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Send Issue Closed Notification
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${{ env.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=<b>Koda</b> | Issue Resolved

          Issue closed!

          Title: <b>${{ github.event.issue.title }}</b>
          Closed by: <b>${{ github.event.sender.login }}</b>

          <a href='${{ github.event.issue.html_url }}'>View Issue</a>"

  # Issue Comment
  notify-comment:
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    steps:
      - name: Send Comment Notification
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${{ env.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=<b>Koda</b> | New Comment

          Someone commented!

          On: <b>${{ github.event.issue.title }}</b>
          By: <b>${{ github.event.comment.user.login }}</b>

          <a href='${{ github.event.comment.html_url }}'>Read Comment</a>"

  # Star Milestone (only notify on 10, 20, 30, 40, 50, etc.)
  notify-star-milestone:
    if: github.event_name == 'watch' && github.event.action == 'started'
    runs-on: ubuntu-latest
    steps:
      - name: Check if Star Milestone
        id: check-milestone
        run: |
          STAR_COUNT=${{ github.event.repository.stargazers_count }}
          # Notify on every 10 stars (10, 20, 30, 40, 50, etc.)
          if [ $((STAR_COUNT % 10)) -eq 0 ] && [ $STAR_COUNT -gt 0 ]; then
            echo "is_milestone=true" >> $GITHUB_OUTPUT
          else
            echo "is_milestone=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Star Milestone Notification
        if: steps.check-milestone.outputs.is_milestone == 'true'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${{ env.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=<b>Koda</b> | ‚≠ê Star Milestone!

          üéâ We reached <b>${{ github.event.repository.stargazers_count }}</b> stars!

          Latest stargazer: <b>${{ github.event.sender.login }}</b>

          Thank you for your amazing support!
          <a href='https://github.com/${{ github.repository }}'>Visit Repo</a>"


  # Fork
  notify-fork:
    if: github.event_name == 'fork'
    runs-on: ubuntu-latest
    steps:
      - name: Send Fork Notification
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${{ env.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=<b>Koda</b> | Forked!

          Repository forked!

          <b>${{ github.event.sender.login }}</b> forked the project!
          Fork: <code>${{ github.event.forkee.full_name }}</code>

          Happy coding!
          <a href='${{ github.event.forkee.html_url }}'>View Fork</a>"

  # Release
  notify-release:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Send Release Notification
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${{ env.TELEGRAM_CHAT_ID }}" \
            -d "parse_mode=HTML" \
            -d "text=<b>Koda</b> | New Release!

          Version <b>${{ github.event.release.tag_name }}</b>

          Name: <b>${{ github.event.release.name }}</b>
          Author: <b>${{ github.event.release.author.login }}</b>

          <a href='${{ github.event.release.html_url }}'>Download Now</a>"
